<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="x5ktgciuUZaSdL_MVZTZbxB3KlpKTLWWRI5NuYoIlXo">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"tom89757.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æœ¬æ–‡è®°å½•ä¸€ä¸‹PyTorchä¸­æœ€æ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€â€”â€”torch.utils.dataã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="PyTorch torch.utils.data">
<meta property="og:url" content="https://tom89757.github.io/2022/07/20/PyTorch-torch-utils-data/index.html">
<meta property="og:site_name" content="ä¸–ç•Œåœ¨æˆ‘é¢å‰å±•å¼€">
<meta property="og:description" content="æœ¬æ–‡è®°å½•ä¸€ä¸‹PyTorchä¸­æœ€æ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€â€”â€”torch.utils.dataã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-20T13:55:35.000Z">
<meta property="article:modified_time" content="2022-07-20T13:58:07.023Z">
<meta property="article:author" content="å¹»å…‰">
<meta property="article:tag" content="Pytorch">
<meta property="article:tag" content="æ–‡æ¡£">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://tom89757.github.io/2022/07/20/PyTorch-torch-utils-data/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://tom89757.github.io/2022/07/20/PyTorch-torch-utils-data/","path":"2022/07/20/PyTorch-torch-utils-data/","title":"PyTorch torch.utils.data"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PyTorch torch.utils.data | ä¸–ç•Œåœ¨æˆ‘é¢å‰å±•å¼€</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?a5a702eb0224989403c29d3c91b068f0"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="ä¸–ç•Œåœ¨æˆ‘é¢å‰å±•å¼€" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ä¸–ç•Œåœ¨æˆ‘é¢å‰å±•å¼€</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">æ­»äº¡æ‰‘é¢è€Œæ¥ è…æœ½æ¥è¸µè€Œè‡³</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#torchutilsdata"><span class="nav-number">1.</span> <span class="nav-text"> torch.utils.data</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dataset-types"><span class="nav-number">1.1.</span> <span class="nav-text"> Dataset Types</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#map-style-datasets"><span class="nav-number">1.2.</span> <span class="nav-text"> Map-Style datasets</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#iterable-style-datasets"><span class="nav-number">1.3.</span> <span class="nav-text"> Iterable-style datasets</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#data-loading-order-and-sampler"><span class="nav-number">1.4.</span> <span class="nav-text"> Data Loading Order and Sampler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#loading-batched-and-non-batched-data"><span class="nav-number">1.5.</span> <span class="nav-text"> Loading Batched and Non-Batched Data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disable-automatic-batching"><span class="nav-number">1.6.</span> <span class="nav-text"> Disable automatic batching</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#working-with-collate_fn"><span class="nav-number">1.7.</span> <span class="nav-text"> Working with collate_fn</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#single-and-multi-process-data-loading"><span class="nav-number">1.8.</span> <span class="nav-text"> Single- and Multi-process Data Loading</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#memory-pinning"><span class="nav-number">1.9.</span> <span class="nav-text"> Memory Pinning</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#torchutilsdatadataset"><span class="nav-number">1.10.</span> <span class="nav-text"> torch.utils.data.Dataset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#torchutilsdatadefault_collatebatch"><span class="nav-number">1.11.</span> <span class="nav-text"> torch.utils.data.default_collate(batch)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#torchutilsdatasamplerdata_source"><span class="nav-number">1.12.</span> <span class="nav-text"> torch.utils.data.Sampler(data_source)</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">å¹»å…‰</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">96</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Tom89757" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Tom89757" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml" rel="noopener me"><i class="rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tom89757.github.io/2022/07/20/PyTorch-torch-utils-data/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å¹»å…‰">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸–ç•Œåœ¨æˆ‘é¢å‰å±•å¼€">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PyTorch torch.utils.data | ä¸–ç•Œåœ¨æˆ‘é¢å‰å±•å¼€">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PyTorch torch.utils.data
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-07-20 21:55:35 / ä¿®æ”¹æ—¶é—´ï¼š21:58:07" itemprop="dateCreated datePublished" datetime="2022-07-20T21:55:35+08:00">2022-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">æ·±åº¦å­¦ä¹ </span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>10 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>æœ¬æ–‡è®°å½•ä¸€ä¸‹PyTorchä¸­æœ€æ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€â€”â€”<code>torch.utils.data</code>ã€‚</p>
<span id="more"></span>
<h3 id="torchutilsdata"><a class="markdownIt-Anchor" href="#torchutilsdata"></a> torch.utils.data</h3>
<p>è¯¥ package çš„æ ¸å¿ƒç±»ä¸º <code>torch.utils.data.DataLoader</code>ï¼Œè¡¨ç¤ºåœ¨ä¸€ä¸ªæ•°æ®é›†ä¸Šçš„è¿­ä»£ï¼Œå…¶æ”¯æŒï¼š</p>
<ul>
<li>map-style å’Œ iterable-style çš„æ•°æ®é›†</li>
<li>å®šåˆ¶åŒ–æ•°æ®åŠ è½½é¡ºåº</li>
<li>è‡ªåŠ¨ batching</li>
<li>å•çº¿ç¨‹å’Œå¤šçº¿ç¨‹çš„æ•°æ®åŠ è½½</li>
<li>è‡ªåŠ¨å†…å­˜ pinning (å›ºå®š)</li>
</ul>
<p>è¿™äº›é€‰é¡¹é€šè¿‡ä»¥ä¸‹çš„ <code>DataLoader</code> å¯¹è±¡çš„æ„é€ å™¨é…ç½®ï¼Œå…¶æœ‰signatureï¼š</p>
<pre><code>DataLoader(dataset, batch_size=1, shuffle=False, sampler=None,
           batch_sampler=None, num_workers=0, collate_fn=None,
           pin_memory=False, drop_last=False, timeout=0,
           worker_init_fn=None, *, prefetch_factor=2,
           persistent_workers=False)
</code></pre>
<h4 id="dataset-types"><a class="markdownIt-Anchor" href="#dataset-types"></a> Dataset Types</h4>
<p><code>DataLoader</code>æ„é€ å™¨æœ€é‡è¦çš„å‚æ•°ä¸º<code>dataset</code>ï¼Œå®ƒæŒ‡å®šäº†ä»ä¸­åŠ è½½æ•°æ®çš„æ•°æ®é›†å¯¹è±¡ã€‚PyTorchæ”¯æŒä¸¤ç§ä¸åŒç±»å‹çš„æ•°æ®é›†ï¼š</p>
<ul>
<li>map-style datasets</li>
<li>iterable-style datasets</li>
</ul>
<h4 id="map-style-datasets"><a class="markdownIt-Anchor" href="#map-style-datasets"></a> Map-Style datasets</h4>
<p>ä¸€ä¸ªmap-styleçš„æ•°æ®é›†éœ€è¦å®ç°<code>__getitem__()</code>å’Œ<code>__len__()</code>è¿™ä¸¤ä¸ªprotocolsï¼Œè¡¨ç¤ºä»indices/keys (å¯èƒ½éæ•´å‹) åˆ° data samplesçš„æ˜ å°„ã€‚</p>
<blockquote>
<p>protocols: ç®¡ç†æ•°æ®ä¼ è¾“å’Œæ¥æ”¶çš„å½¢å¼å’Œæ­¥éª¤ï¼Œå¦‚HTTP protocolã€‚</p>
</blockquote>
<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªæ•°æ®é›†ï¼Œå½“èƒ½å¤Ÿé€šè¿‡<code>dataset[idx]</code>è®¿é—®æ—¶ï¼Œå¯ä»¥ä»ç£ç›˜ä¸Šçš„æ–‡ä»¶å¤¹ä¸­è¯»å–ç¬¬<code>idx</code>å¼ imageå’Œå®ƒå¯¹åº”çš„labelã€‚è¯¦è§ <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html#torch.utils.data.Dataset"><code>Dataset</code></a></p>
<h4 id="iterable-style-datasets"><a class="markdownIt-Anchor" href="#iterable-style-datasets"></a> Iterable-style datasets</h4>
<p>ä¸€ä¸ªiterable-styleçš„æ•°æ®é›†æ˜¯<code>IterableDataset</code>å­ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å­ç±»éœ€è¦å®ç°<code>__iter__()</code> protocolï¼Œå¹¶ä¸”è¡¨ç¤ºåœ¨data samplesä¸Šçš„ä¸€ä¸ªè¿­ä»£ã€‚è¿™ç§ç±»å‹çš„æ•°æ®é›†å°¤å…¶é€‚åˆè¿™ç§æƒ…å†µï¼Œå½“éšæœºè¯»å–ä»£ä»·å¾ˆå¤§ç”šè‡³ä¸å¯èƒ½ï¼Œæˆ–è€…batch sizeä¾èµ–äºæ‰€è·å–çš„æ•°æ®ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªæ•°æ®é›†ï¼Œå½“è°ƒç”¨<code>iter(dataset)</code>æ—¶ï¼Œå¯ä»¥è¿”å›æ¥è‡ªæ•°æ®åº“ã€è¿œç¨‹æœåŠ¡å™¨ç”šè‡³å®æ—¶ç”Ÿæˆçš„logsçš„æ•°æ®è¯»å–æµã€‚è¯¦è§ <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html#torch.utils.data.IterableDataset"><code>IterableDataset</code></a></p>
<p>PSï¼šå½“ä½¿ç”¨<code>IterableDataset</code>è¿›è¡Œmulti-process data loadingæ—¶ï¼Œç›¸åŒçš„æ•°æ®å¯¹è±¡åœ¨æ¯ä¸ªworker processä¸Šé‡å¤ï¼Œå› æ­¤å¿…é¡»å¯¹å‰¯æœ¬è¿›è¡Œä¸åŒçš„é…ç½®ä»¥é¿å…é‡å¤æ•°æ®ï¼Œå¯ä»¥çœ‹ <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html#torch.utils.data.IterableDataset"><code>IterableDataset</code></a>æ–‡æ¡£äº†è§£å¦‚ä½•å®ç°ã€‚</p>
<h4 id="data-loading-order-and-sampler"><a class="markdownIt-Anchor" href="#data-loading-order-and-sampler"></a> Data Loading Order and <code>Sampler</code></h4>
<p>å¯¹äº iterable-style æ•°æ®é›†ï¼Œæ•°æ®åŠ è½½é¡ºåºå®Œå…¨ç”±ç”¨æˆ·å®šä¹‰çš„è¿­ä»£å™¨æ§åˆ¶ã€‚è¿™å…è®¸æ›´å®¹æ˜“çš„chunk-readingå’ŒåŠ¨æ€çš„batch sizeçš„å®ç°ï¼ˆå¦‚ï¼Œé€šè¿‡æ¯æ¬¡ç”Ÿæˆä¸€ä¸ª batched sampleï¼‰</p>
<p>æœ¬èŠ‚çš„å‰©ä½™éƒ¨åˆ†å…³å¿ƒmap-styleæ•°æ®é›†çš„æƒ…å†µã€‚<code>torch.utils.data.Sampler</code>ç±»è¢«ç”¨æ¥æŒ‡å®šåœ¨æ•°æ®åŠ è½½ä¸­ä½¿ç”¨çš„indices/keysçš„åºåˆ—ã€‚å®ƒä»¬ä»£è¡¨åœ¨æ•°æ®é›†indicesä¸Šçš„è¿­ä»£å™¨å¯¹è±¡ï¼Œä¾‹å¦‚ï¼Œåœ¨SGD (stochastic gradient decent) çš„å…¬å…±å®ä¾‹ä¸­ï¼Œä¸€ä¸ªSamplerå¯ä»¥ä»»æ„æ’åˆ—indicesçš„åˆ—è¡¨å¹¶ä¸”æ¯æ¬¡ç”Ÿæˆä¸€ä¸ªindiceï¼Œæˆ–è€…å¯¹äºmini-batch SGDç”Ÿæˆå°‘é‡indicesã€‚</p>
<p>ä¸€ä¸ªsequentialæˆ–è€…shuffledçš„samplerå°†ä¼šè‡ªåŠ¨æ ¹æ®ä¼ é€’ç»™<code>Dataloader</code>çš„<code>shuffle</code>å‚æ•°æ„é€ ã€‚å¯é€‰åœ°ï¼Œç”¨æˆ·å¯èƒ½ä½¿ç”¨<code>sampler</code>å‚æ•°æ¥æŒ‡å®šä¸€ä¸ªcustom Sampler objectï¼Œæ¯æ¬¡ç”Ÿæˆè¦å–çš„ä¸‹ä¸€ä¸ªindex/keyã€‚</p>
<p>ä¸€ä¸ªå¯ä»¥ä¸€æ¬¡ç”Ÿæˆä¸€ä¸ªbatch indicesåˆ—è¡¨çš„custom Samplerå¯ä»¥ä½œä¸º<code>batch_sampler</code>å‚æ•°ä¼ é€’ã€‚automatic batchingå¯ä»¥é€šè¿‡<code>batch_size</code>å’Œ<code>drop_last</code>å‚æ•°æ¥å¼€å¯ã€‚è¯¦è§ä¸‹èŠ‚è·å–ç»†èŠ‚ã€‚</p>
<p>PSï¼š<code>sampler</code>å’Œ<code>batch_sampler</code>éƒ½ä¸å…¼å®¹iterable-styleæ•°æ®é›†ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰key/indexçš„æ¦‚å¿µã€‚</p>
<h4 id="loading-batched-and-non-batched-data"><a class="markdownIt-Anchor" href="#loading-batched-and-non-batched-data"></a> Loading Batched and Non-Batched Data</h4>
<p><code>DataLoader</code>æ”¯æŒè‡ªåŠ¨åœ°å°†é€šè¿‡<code>batch_size</code>ã€<code>drop_last</code>ã€<code>batch_sampler</code>å’Œ<code>collate_fn</code>(æœ‰é»˜è®¤å‡½æ•°)å‚æ•°çš„æ¯ä¸ªå–åˆ°çš„data samplesæ•´ç†åˆ°batchesä¸­ã€‚</p>
<p><strong>Automatic batching(default)</strong></p>
<p>æœ€é€šç”¨çš„æƒ…å†µï¼Œå¯¹åº”å–å¾— a minibatch of dataå¹¶å°†å®ƒä»¬æ•´ç†è¿›batched samplersï¼Œä¾‹å¦‚æ•´ç†ä¸€ç»´Tensorsä¸ºbatchçš„ç»´åº¦ã€‚</p>
<p>å½“<code>batch_size</code>(é»˜è®¤ä¸º1)ä¸ä¸ºNoneæ—¶ï¼Œdata loaderç”Ÿæˆbatched samplesè€Œä¸æ˜¯individual samplesï¼Œ<code>batch_size</code>å’Œ<code>drop_last</code>è¢«ç”¨æ¥æŒ‡å®šdata loaderå¦‚ä½•è·å–batches of dataset keysã€‚å¯¹äºmap-styleæ•°æ®é›†ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æŒ‡å®š<code>batch_sampler</code>ï¼Œå…¶å°†ä¸€æ¬¡ç”Ÿæˆä¸€ä¸ªlist of keysã€‚</p>
<p>PSï¼š<code>batch_size</code>å’Œ<code>drop_last</code>æ˜¯ç”¨æ¥ä»<code>sampler</code>ä¸­æ„å»ºä¸€ä¸ª<code>batch_sampler</code>çš„å…³é”®ã€‚å¯¹äºmap-styleæ•°æ®é›†ï¼Œ<code>sampler</code>è¦ä¹ˆç”±ç”¨æˆ·æä¾›ï¼Œè¦ä¹ˆåŸºäº<code>shuffle</code>å‚æ•°æ„å»ºã€‚å¯¹äºiterable-styleæ•°æ®é›†ï¼Œæ²¡æœ‰<code>sampler</code>æˆ–<code>batch_sampler</code>çš„æ¦‚å¿µ</p>
<p>åœ¨é€šè¿‡samplerçš„indiceså–å¾— a list of samplesåï¼Œä½œä¸º<code>collate_fn</code>å‚æ•°ä¼ é€’çš„å‡½æ•°è¢«ç”¨æ¥å°†list of samplesæ•´ç†ä¸ºbatchesã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»map-styleæ•°æ®é›†ä¸­çš„åŠ è½½æ•°æ®å¯ä»¥å¤§è‡´ç­‰ä»·äºï¼š</p>
<pre><code>for indices in batch_sampler:
    yield collate_fn([dataset[i] for i in indices])
</code></pre>
<p>ä»iterable-styleæ•°æ®é›†ä¸­åŠ è½½æ•°æ®å¯ä»¥å¤§è‡´ç­‰ä»·äºï¼š</p>
<pre><code>dataset_iter = iter(dataset)
for indices in batch_sampler:
    yield collate_fn([next(dataset_iter) for _ in indices])
</code></pre>
<p>ä¸€ä¸ªcustom <code>collate_fn</code> å¯ä»¥è¢«ç”¨æ¥ customize collationï¼Œä¾‹å¦‚ï¼Œå¡«å……åºåˆ—æ•°æ®åˆ°batchçš„æœ€å¤§é•¿åº¦ã€‚</p>
<h4 id="disable-automatic-batching"><a class="markdownIt-Anchor" href="#disable-automatic-batching"></a> Disable automatic batching</h4>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯èƒ½æƒ³åœ¨æ•°æ®é›†ä¸­æ‰‹åŠ¨ç®¡ç†batchingï¼Œæˆ–è€…åªæ˜¯ç®€å•åœ°åŠ è½½individual samplesã€‚ä¾‹å¦‚ï¼Œå¯èƒ½ç›´æ¥åŠ è½½batched dataä»£ä»·æ›´å°ï¼ˆä¾‹å¦‚ä»æ•°æ®åº“ä¸­è¿›è¡Œå—è®¿é—®ï¼Œæˆ–è€…è¯»å–è¿ç»­çš„å†…å­˜å—ï¼‰ï¼Œæˆ–è€…batch sizeæ˜¯æ•°æ®ä¾èµ–çš„ï¼Œæˆ–è€…ç¨‹åºè¢«è®¾è®¡åœ¨individual sampleä¸Šè¿è¡Œã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸ä½¿ç”¨automatic batchingï¼ˆä½¿ç”¨<code>collate_fn</code>æ•´ç†samplesï¼‰å¯èƒ½æ›´å¥½ï¼Œæ­¤æ—¶å¯ä»¥è®©æ•°æ®åŠ è½½å™¨ç›´æ¥è¿”å›datasetå¯¹è±¡çš„æ¯ä¸ªæˆå‘˜ã€‚</p>
<p>å½“<code>batch_size</code>å’Œ<code>batch_sampler</code>éƒ½ä¸ºNoneæ—¶ï¼ˆé»˜è®¤<code>batch_sampler</code>ä¸ºNoneï¼Œå°±ç¦æ­¢äº†automatic batchingã€‚æ¯ä¸ªä»datasetä¸­è·å–çš„samplerè¢«ä½œä¸º<code>collate_fn</code>å‚æ•°ä¼ é€’çš„å‡½æ•°å¤„ç†ã€‚</p>
<p>å½“ç¦æ­¢automatic batchingï¼Œé»˜è®¤çš„<code>collate_fn</code>ç®€å•çš„è½¬æ¢Numpy arraysä¸ºPytorch Tensorsï¼Œå¹¶ä¸”ä¿æŒeverything else untouchedã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»ä¸€ä¸ªmap-styleæ•°æ®é›†ä¸­åŠ è½½æ•°æ®å¯ä»¥å¤§è‡´ç­‰ä»·äºï¼š</p>
<pre><code>for index in sampler:
    yield collate_fn(dataset[index])
</code></pre>
<p>ä»ä¸€ä¸ªiterable-styleæ•°æ®é›†ä¸­åŠ è½½æ•°æ®å¯ä»¥å¤§è‡´ç­‰ä»·äºï¼š</p>
<pre><code>for data in iter(dataset):
    yield collate_fn(data)
</code></pre>
<h4 id="working-with-collate_fn"><a class="markdownIt-Anchor" href="#working-with-collate_fn"></a> Working with <code>collate_fn</code></h4>
<p>å½“å¯ç”¨æˆ–ç¦ç”¨automatic batchingæ—¶ï¼Œ<code>collate_fn</code>çš„ä½¿ç”¨ç•¥æœ‰ä¸åŒã€‚</p>
<p>å½“ç¦ç”¨batchingæ—¶ï¼Œ<code>collate_fn</code>è¢«å•ä¸ªçš„data sampleè°ƒç”¨ï¼Œè¾“å‡ºä»data loader iteratorä¸­ç”Ÿæˆã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé»˜è®¤çš„<code>default_fn</code>ç®€å•åœ°è½¬æ¢Numpy arraysä¸ºPytorch tensorsã€‚</p>
<p>å½“å¯ç”¨batchingæ—¶ï¼Œ<code>collate_fn</code>æ¯æ¬¡è¢«a list of data samplesè°ƒç”¨ï¼Œéœ€è¦å°†ç”Ÿæˆçš„input samplesæ•´ç†ä¸ºa batchã€‚æœ¬èŠ‚çš„å‰©ä½™éƒ¨åˆ†æè¿°é»˜è®¤çš„<code>collate_fn</code> (<a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html#torch.utils.data.default_collate"><code>default_collate()</code></a>) çš„è¡Œä¸ºã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæ¯ä¸ªsampleåŒ…å«ä¸€ä¸ª3-channelçš„æ•°æ®å’Œä¸€ä¸ªæ•´å‹çš„class labelï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œdatasetçš„æ¯ä¸ªå…ƒç´ è¿”å›ä¸€ä¸ªtuple (<code>image, class_index</code>)ï¼Œé»˜è®¤çš„<code>collate_fn</code>ä¼šæ•´ç†è¿™æ ·çš„list of tuplesåˆ°a single tuple of a batched image tensorå’Œa batched class label Tensorã€‚å°¤å…¶æ˜¯ï¼Œé»˜è®¤çš„<code>collate_fn</code>æœ‰å¦‚ä¸‹çš„å±æ€§ï¼š</p>
<ul>
<li>
<p>æ€»æ˜¯å°†batch dimensionä½œä¸ºæ–°çš„dimension</p>
</li>
<li>
<p>è‡ªåŠ¨åœ°è½¬æ¢NumPy arrayså’ŒPython numerical valuesä¸ºPyTorch Tensors</p>
</li>
<li>
<p>ä¿ç•™æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚å¦‚æœæ¯ä¸ªsampleä¸ºä¸€ä¸ªdictionaryï¼Œå®ƒè¾“å‡ºä¸€ä¸ªæœ‰ç›¸åŒset of keysçš„dictï¼Œä½†æ˜¯å°†batched Tensorsä½œä¸ºå€¼ï¼ˆæˆ–è€…listsï¼Œå¦‚æœå€¼ä¸èƒ½è½¬æ¢ä¸ºTensorsï¼‰ã€‚å¯¹listã€tupleã€namedtupleéƒ½æ˜¯å¦‚æ­¤ã€‚</p>
<p>ç”¨æˆ·å¯èƒ½ä½¿ç”¨å®šåˆ¶åŒ–çš„<code>collate_fn</code>æ¥å®ç°custom batchingï¼Œä¾‹å¦‚ï¼Œæ²¿ç€ä¸€ä¸ªç»´åº¦æ•´ç†è€Œä¸æ˜¯ç¬¬ä¸€ä¸ªï¼Œå¡«å……å˜é•¿çš„åºåˆ—ï¼Œæˆ–è€…å¯¹custom data typesæ·»åŠ supportã€‚</p>
</li>
</ul>
<p>å¦‚æœä½ é‡åˆ°DataLoaderçš„è¾“å‡ºçš„ç»´åº¦æˆ–ç±»å‹å’ŒæœŸæœ›çš„ä¸åŒï¼Œä½ åº”è¯¥æ£€æŸ¥ä½ çš„<code>collate_fn</code>ã€‚</p>
<h4 id="single-and-multi-process-data-loading"><a class="markdownIt-Anchor" href="#single-and-multi-process-data-loading"></a> Single- and Multi-process Data Loading</h4>
<p>DataLoaderé»˜è®¤ä½¿ç”¨single-processæ•°æ®åŠ è½½ã€‚</p>
<p>åœ¨ä¸€ä¸ªPython processå†…éƒ¨ï¼Œ<a target="_blank" rel="noopener" href="https://wiki.python.org/moin/GlobalInterpreterLock">Global Interpreter Lock (GIL)</a> é¿å…åœ¨threadsçš„å®Œå…¨å¹¶è¡Œçš„Pythonä»£ç ã€‚ä¸ºäº†é¿å…blockæ•°æ®åŠ è½½æ—¶çš„computation codeï¼ŒPytorché€šè¿‡å°†<code>num_workers</code>è®¾ç½®ä¸ºæ­£å€¼æ¥è¿›è¡Œmulti-processçš„æ•°æ®å¤„ç†ã€‚</p>
<p><strong>Single-process data loading (default)</strong></p>
<p>åœ¨è¿™ä¸ªæ¨¡å¼ï¼Œdata fetchingå’ŒDataLoaderåˆå§‹åŒ–åœ¨ç›¸åŒçš„processä¸­è¿›è¡Œã€‚å› æ­¤ï¼Œæ•°æ®åŠ è½½å¯èƒ½ä¼šblock computingã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæ¨¡å¼å¯èƒ½åœ¨èµ„æºåœ¨processes (å¦‚ï¼Œshared memory, file descriptors) ä¹‹é—´å…±äº«æ•°æ®è¢«é™åˆ¶æ—¶ä½¿ç”¨ä¼šæ›´å¥½ï¼Œæˆ–è€…æ•´ä¸ªæ•°æ®é›†å¾ˆå°å¯ä»¥å®Œå…¨åœ¨å†…å­˜ä¸­æ•´ä¸ªåŠ è½½ã€‚æ­¤å¤–ï¼Œsingle-processåŠ è½½é€šè¿‡åœ¨è¿›è¡Œerror traceæ—¶æ›´å…·æœ‰å¯è¯»æ€§ï¼Œå› æ­¤å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚</p>
<p><strong>Multi-process data loading</strong></p>
<p>è®¾ç½®å‚æ•°<code>num_workers</code>ä¸ºæ­£æ•°å¯ä»¥ç”¨æŒ‡å®šæ•°é‡çš„loader worker processesæ¥multi-processåœ°åŠ è½½æ•°æ®ã€‚</p>
<blockquote>
<p>Warningï¼šåœ¨æ•°æ¬¡è¿­ä»£ä¹‹åï¼Œloader worker processeså°†æ¶ˆè€—å’Œparent processç›¸åŒé‡çš„CPU memoryã€‚ç•¥</p>
</blockquote>
<p>åœ¨è¿™ä¸ªæ¨¡å¼ï¼Œæ¯æ¬¡DataLoaderçš„ä¸€ä¸ªè¿­ä»£å™¨è¢«åˆ›å»ºæ—¶ï¼ˆå¦‚å½“ä½ è°ƒç”¨enumerate(dataloader)ï¼‰ï¼Œ<code>num_workers</code>æ•°é‡çš„worker processesä¹Ÿè¢«åˆ›å»ºã€‚æ­¤æ—¶ï¼Œ<code>dataset</code>ã€<code>collate_fn</code>å’Œ<code>worker_init_fn</code>è¢«ä¼ é€’ç»™æ¯ä¸ªworkerï¼Œworkeråˆ©ç”¨è¿™äº›å‚æ•°è¿›è¡Œåˆå§‹åŒ–å¹¶ä¸”è·å–æ•°æ®ã€‚è¿™æ„å‘³ç€æ•°æ®é›†çš„è®¿é—®è¿åŒå®ƒçš„å†…éƒ¨IOï¼Œtransforms (åŒ…æ‹¬<code>collate_fn</code>) åœ¨worker processä¸­è¿è¡Œã€‚</p>
<p><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html#torch.utils.data.get_worker_info" title="torch.utils.data.get_worker_info"><code>torch.utils.data.get_worker_info()</code></a> è¿”å›åœ¨ä¸€ä¸ªworker processä¸­çš„å¤šç§æœ‰ç”¨çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬worker idï¼Œdatasetå‰¯æœ¬ï¼Œåˆå§‹åŒ–seedç­‰ï¼‰ï¼Œå¹¶ä¸”åœ¨main processä¸­è¿”å›Noneã€‚ç”¨æˆ·å¯èƒ½åœ¨datasetä¸­ä½¿ç”¨è¿™ä¸ªå‡½æ•°å’Œ<code>worker_init_fn</code>æ¥å•ç‹¬é…ç½®æ¯ä¸ªdatasetå‰¯æœ¬ï¼Œå¹¶ä¸”åˆ¤æ–­ä»£ç æ˜¯å¦è¿è¡Œåœ¨ä¸€ä¸ªworker processä¸­ã€‚ä¾‹å¦‚ï¼Œè¿™å¯èƒ½åœ¨sharding the datasetæ—¶å°¤å…¶æœ‰ç”¨</p>
<blockquote>
<p>sharding: å°†æ•°æ®é›†å­˜å‚¨åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Š</p>
</blockquote>
<p>å¯¹map-styleçš„æ•°æ®é›†ï¼Œmain processä½¿ç”¨<code>sampler</code>ç”Ÿæˆindicesç„¶åå°†indiceså‘é€ç»™workersã€‚æ‰€ä»¥ä»»ä½•shuffleéšæœºåŒ–åœ¨main processä¸­è¿›è¡Œï¼Œç„¶åå†é€šè¿‡indicesè¿›è¡Œå¼•å¯¼æ•°æ®åŠ è½½ã€‚</p>
<p>å¯¹äºiterable-styleæ•°æ®é›†ï¼Œå› ä¸ºæ¯ä¸ªworker processå¾—åˆ°ä¸€ä¸ªæ•°æ®é›†å¯¹è±¡çš„å‰¯æœ¬ï¼Œç›´æ¥è¿›è¡Œmulti-processåŠ è½½ç»å¸¸ä¼šå¯¼è‡´æ•°æ®é‡å¤ã€‚ä½¿ç”¨<code>torch.utils.data.get_worker_info()</code>å’Œ<code>worker_init_fn</code>ï¼Œç”¨æˆ·å¯ä»¥ç‹¬ç«‹é…ç½®æ¯ä¸ªå‰¯æœ¬ã€‚</p>
<p>ä¸€æ—¦è¿­ä»£ç»ˆæ­¢æˆ–è€…è¿­ä»£å™¨è¢«è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œworkerså°±ä¼šç»ˆæ­¢ã€‚</p>
<p>PSï¼šé€šå¸¸ä¸å»ºè®®åœ¨multi-processåŠ è½½ä¸­è¿”å›CUDA tensorsï¼Œå› ä¸ºè®¸å¤šå¾®å¦™çš„åŸå› ï¼Œè¯¦è§<a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/notes/multiprocessing.html#multiprocessing-cuda-note">CUDA in multiprocessing</a>ã€‚ä½œä¸ºæ›¿ä»£ï¼Œå»ºè®®ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html#memory-pinning">automatic memory pinning</a>(ä¹Ÿå°±æ˜¯è®¾ç½®<code>pin_memory=True</code>)ï¼Œè¿™å¯ä»¥åœ¨CUDA-enabled GPUsä¸Šè¿›è¡Œå¾ˆå¿«çš„æ•°æ®ä¼ è¾“ã€‚</p>
<p><strong>Platform-specific behaviors</strong></p>
<p>å› ä¸ºworkersä¾èµ–äºPython <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" title="(in Python v3.10)"><code>multiprocessing</code></a>ï¼Œworkerçš„å¯åŠ¨è¡Œä¸ºåœ¨Windowså’ŒUnixå¹³å°ä¸Šæœ‰æ‰€ä¸åŒã€‚ç•¥</p>
<p>PSï¼šå»ºè®®å°†ä¸»è¦çš„scriptä»£ç æ”¾åœ¨<code>if __name__=='__main__'</code>ä¸­ï¼›å»ºè®®ç¡®ä¿<code>collate_fn</code>ã€<code>worker_init_fn</code>å’Œ<code>dataset</code>ä»£ç åœ¨æœ€å¤–å±‚è¢«å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯<code>__main__</code>çš„å¤–é¢ã€‚</p>
<p><strong>Randomness in multi-process data loading</strong></p>
<p>é»˜è®¤ï¼Œæ¯ä¸ªworkerå°†å®ƒçš„PyTorch seedè®¾ç½®ä¸º<code>base_seed</code>+<code>worker_id</code>ï¼Œ<code>base_seed</code>æ˜¯main processé€šè¿‡å®ƒçš„RNGæˆ–è€…ä¸€ä¸ªæŒ‡å®šçš„<code>generator</code>ç”Ÿæˆã€‚ä½†æ˜¯ï¼Œæ¥è‡ªå…¶ä»–librariesçš„seedså¯èƒ½åœ¨åˆå§‹åŒ–workersæ—¶é‡å¤ï¼Œå¯¼è‡´æ¯ä¸ªworkerè¿”å›ç›¸åŒçš„éšæœºæ•°å­—ã€‚</p>
<p>åœ¨<code>worker_init_fn</code>ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡<a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html#torch.utils.data.get_worker_info" title="torch.utils.data.get_worker_info"><code>torch.utils.data.get_worker_info().seed</code></a> å’Œ <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.initial_seed.html#torch.initial_seed" title="torch.initial_seed"><code>torch.initial_seed()</code></a>è®¿é—®æ¯ä¸ªworkerçš„PyTorch seed setï¼Œå¹¶ä¸”ä½¿ç”¨å®ƒæ¥åœ¨æ•°æ®åŠ è½½ä¹‹å‰seedå…¶ä»–çš„librariesã€‚</p>
<h4 id="memory-pinning"><a class="markdownIt-Anchor" href="#memory-pinning"></a> Memory Pinning</h4>
<p>ä»ä¸»æœºåˆ°GPUçš„æ•°æ®çš„copiesä¼šå¿«å¾—å¤šï¼Œå½“å®ƒä»¬ä» pinned (page-locked) memory ä¸­åˆ›å»ºæ—¶ã€‚è¯¦è§ <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/notes/cuda.html#cuda-memory-pinning">Use pinned memory buffers</a> å¦‚ä½•æ›´é€šç”¨åœ°ä½¿ç”¨ pinned memoryã€‚</p>
<p>å¯¹äºæ•°æ®åŠ è½½æ¥è¯´ï¼Œä¼ é€’<code>pin_memory=True</code>ç»™<code>Dataloader</code>å°†è‡ªåŠ¨çš„æŠŠè·å–åˆ°çš„æ•°æ®æ”¾åœ¨pinned memoryï¼Œå› æ­¤ä¼šä½¿å¾—å¯¹CUDA-enabled GPUsæœ‰æ›´å¿«çš„æ•°æ®ä¼ è¾“ã€‚</p>
<p>é»˜è®¤çš„memory pinning logic åªä¼šè¯†åˆ«Tensorså’ŒåŒ…å«Tensorsçš„maps/iterablesã€‚é»˜è®¤ï¼Œå¦‚ä½•pinning logicçœ‹åˆ°ä¸€ä¸ªcustom type (å¦‚æœä½ æœ‰ä¸€ä¸ª<code>collate_fn</code>è¿”å›ä¸€ä¸ªcustom batch type)ï¼Œæˆ–è€…ä½ çš„batchçš„æ¯ä¸ªå…ƒç´ ä¸ºä¸€ä¸ªcustom typeï¼Œpinning logicä¸ä¼šè®¤å‡ºå®ƒä»¬ï¼Œå¹¶å°†è¿”å›batchï¼ˆæˆ–å…ƒç´ ï¼‰è€Œä¸pin the memoryã€‚ä¸ºäº†å¯¹custom batchæˆ–è€…custom data typeè¿›è¡Œmemory pinningï¼Œéœ€è¦åœ¨custom typeä¸­å®šä¹‰ä¸€ä¸ª<code>pin_memory()</code>æ–¹æ³•ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>class SimpleCustomBatch:
    def __init__(self, data):
        transposed_data = list(zip(*data))
        self.inp = torch.stack(transposed_data[0], 0)
        self.tgt = torch.stack(transposed_data[1], 0)

    # custom memory pinning method on custom type
    def pin_memory(self):
        self.inp = self.inp.pin_memory()
        self.tgt = self.tgt.pin_memory()
        return self

def collate_wrapper(batch):
    return SimpleCustomBatch(batch)

inps = torch.arange(10 * 5, dtype=torch.float32).view(10, 5)
tgts = torch.arange(10 * 5, dtype=torch.float32).view(10, 5)
dataset = TensorDataset(inps, tgts)

loader = DataLoader(dataset, batch_size=2, collate_fn=collate_wrapper,
                    pin_memory=True)

for batch_ndx, sample in enumerate(loader):
    print(sample.inp.is_pinned())
    print(sample.tgt.is_pinned())
</code></pre>
<p>å®Œæ•´å£°æ˜å½¢å¼ä¸ºï¼š</p>
<pre><code>CLASS torch.utils.data.DataLoader(dataset, batch_size=1, shuffle=None, sampler=None, batch_sampler=None, num_workers=0, collate_fn=None, pin_memory=False, drop_last=False, timeout=0, worker_init_fn=None, multiprocessing_context=None, generator=None, *, prefetch_factor=2, persistent_workers=False, pin_memory_device='')
</code></pre>
<p>DataLoaderï¼Œè”åˆä¸€ä¸ªdatasetå’Œä¸€ä¸ªsamplerï¼Œæä¾›åœ¨ç»™å®šæ•°æ®é›†ä¸Šçš„ä¸€ä¸ªè¿­ä»£ã€‚</p>
<p>DataLoaderæ”¯æŒmap-styleå’Œiterable-styleçš„æ•°æ®é›†çš„sing-æˆ–multi-processåŠ è½½ï¼Œå®šåˆ¶åŒ–çš„åŠ è½½é¡ºåºå’Œå¯é€‰çš„automatci batching (collation) å’Œmemory pinningã€‚</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li>
<p><code>dataset(Dataset)</code>ï¼šæ•°æ®é›†ï¼Œä»ä¸­åŠ è½½æ•°æ®</p>
</li>
<li>
<p><code>batch_size(int, optional)</code>ï¼šå¯¹æ¯ä¸ªbatchæœ‰å¤šå°‘ä¸ªæ ·æœ¬è¢«åŠ è½½ï¼ˆé»˜è®¤ä¸º1ï¼‰</p>
</li>
<li>
<p><code>shuffle(bool, optional)</code>ï¼šè®¾ç½®ä¸º<code>True</code>æ—¶åœ¨æ¯ä¸ªepochæ•°æ®éƒ½ä¼šreshuffleï¼ˆé»˜è®¤ä¸ºFalseï¼‰</p>
</li>
<li>
<p><code>sampler(Sampler or Iterable, optional)</code>ï¼šå®šä¹‰ä»datasetä¸­è·å–samplesçš„ç­–ç•¥ã€‚å¯ä»¥æ˜¯ä»»ä½•æœ‰<code>__len__</code>å®ç°çš„Iterableã€‚å¦‚æœæŒ‡å®šsamplerï¼Œ<code>shuffle</code> must not be specifiedã€‚</p>
</li>
<li>
<p><code>batch_sampler(Sampler or Iterable, optional)</code>ï¼šç±»ä¼¼samplerï¼Œä½†æ˜¯ä¸€æ¬¡è¿”å›a batch of indicesã€‚å’Œ<code>batch_size</code>ã€<code>shuffle</code>ã€<code>sampler</code>å’Œ<code>drop_last</code>ç›¸äº’æ’æ–¥ã€‚ï¼Ÿ</p>
</li>
<li>
<p><code>num_worker(int, optional)</code>ï¼šç”¨äºdata loadingçš„subprocessesçš„æ•°é‡ã€‚0è¡¨ç¤ºæ•°æ®å°†ä¼šåœ¨main processä¸­åŠ è½½ï¼ˆé»˜è®¤ä¸º0ï¼‰</p>
</li>
<li>
<p><code>collate_fn(callable, optional)</code>ï¼šåˆå¹¶a list of samplesä»¥å½¢æˆ a mini-batch of Tensor(s)ã€‚å½“ä»ä¸€ä¸ªmap-styleæ•°æ®é›†ä¸­è¿›è¡Œbatched loadingæ—¶ä¼šç”¨åˆ°ã€‚</p>
</li>
<li>
<p><code>pin_memory(bool, optional)</code>ï¼šå¦‚æœä¸º<code>True</code>ï¼Œdata loaderåœ¨è¿”å›Tensorä¹‹å‰ä¼šå¤åˆ¶Tensorsåˆ°device/CUDAçš„pinned memoryã€‚å¦‚æœä½ çš„æ•°æ®å…ƒç´ ä¸ºcustom typeï¼Œæˆ–è€…ä½ çš„<code>collate_fn</code>è¿”å›çš„batchä¸ºcustom typeï¼Œçœ‹ä¸‹é¢çš„ç¤ºä¾‹ã€‚</p>
</li>
<li>
<p><code>drop_last(bool, optional)</code>ï¼šè®¾ç½®ä¸º<code>True</code>æ—¶ä¼šdropæœ€åçš„ä¸å®Œæ•´çš„batchï¼Œå¦‚æœdataset sizeä¸èƒ½è¢«batch sizeæ•´é™¤çš„è¯ã€‚å¦‚æœä¸º<code>False</code>ï¼Œæ•°æ®é›†çš„å°ºå¯¸ä¸èƒ½è¢«batch sizeæ•´é™¤ï¼Œé‚£ä¹ˆæœ€åçš„batchå°†ä¼šæ›´å°ï¼ˆé»˜è®¤ä¸ºFalseï¼‰</p>
</li>
<li>
<p><code>timeout(numeric, optional)</code>ï¼šå¦‚æœä¸ºæ­£ï¼Œè¡¨ç¤ºä»workersæ”¶é›†a batchçš„timeoutå€¼ã€‚åº”è¯¥æ€»æ˜¯éè´Ÿï¼ˆé»˜è®¤ä¸º0ï¼‰</p>
</li>
<li>
<p><code>worker_init_fn(callable, optional)</code>ï¼šå¦‚æœä¸ä¸º<code>None</code>ï¼Œå°†ä½¿ç”¨worker id ([0, num_workers-1]èŒƒå›´å†…çš„æ•´æ•°) ä½œä¸ºè¾“å…¥åœ¨æ¯ä¸ªworker subprocessä¸­è¢«è°ƒç”¨ï¼Œåœ¨seedingä¹‹åï¼Œdata loadingä¹‹å‰ï¼ˆé»˜è®¤ä¸ºNoneï¼‰</p>
</li>
<li>
<p><code>generator(torch.Generator, optional)</code>ï¼šå¦‚æœä¸ä¸º<code>None</code>ï¼ŒRandomSamplerå°†ä½¿ç”¨RNGç”Ÿæˆéšæœºindexesï¼Œå¹¶ä¸”ä¸ºworkersç”Ÿæˆ<code>base_seed</code>ï¼ˆé»˜è®¤ä¸ºNoneï¼‰</p>
</li>
<li>
<p><code>prefetch_factor(int, optional, keyword-only arg)</code>ï¼šè¢«æ¯ä¸ªworkeræå‰åŠ è½½çš„batchesçš„æ•°é‡ã€‚<code>2</code>è¡¨ç¤ºåœ¨æ‰€æœ‰wrokersä¸Šå°†æœ‰æ€»å…±2*num_workersçš„batchesè¢«æå‰è·å¾—ï¼ˆé»˜è®¤ä¸º2ï¼‰</p>
</li>
<li>
<p><code>persistent_workers(bool, optional)</code>ï¼šå¦‚æœä¸º<code>True</code>ï¼Œdata loaderåœ¨ä¸€ä¸ªdatasetè¢«å¤„ç†å®Œä¸€æ¬¡åä¸ä¼šå…³é—­worker processesï¼Œè¿™å…è®¸ä¿æŒworkers Dataset instanceså­˜æ´»ï¼ˆé»˜è®¤ä¸ºFalseï¼‰</p>
</li>
<li>
<p><code>pin_memory_device(str, optional)</code>ï¼šå¦‚æœpin_memoryè®¾ç½®ä¸ºTrueï¼Œdata loaderåœ¨è¿”å›Tensorsä¹‹å‰ä¼šå°†ä»–ä»¬å¤åˆ¶åˆ°device pinned memoryã€‚</p>
</li>
</ul>
<h4 id="torchutilsdatadataset"><a class="markdownIt-Anchor" href="#torchutilsdatadataset"></a> torch.utils.data.Dataset</h4>
<p>ä¸€ä¸ªè¡¨ç¤ºDatasetçš„æŠ½è±¡ç±»ã€‚</p>
<p>æ‰€æœ‰è¡¨ç¤ºä»keysåˆ°data samplesçš„æ˜ å°„çš„æ•°æ®é›†éƒ½åº”è¯¥æ˜¯å®ƒçš„å­ç±»ã€‚æ‰€æœ‰çš„å­ç±»åº”è¯¥é‡å†™<code>__getitme__()</code>ï¼Œè¯¥æ–¹æ³•æ”¯æŒå¯¹ä¸€ä¸ªç»™å®šçš„keyè·å–å¯¹åº”çš„data sampleã€‚å­ç±»ä¹Ÿèƒ½é€‰æ‹©æ€§åœ°é‡å†™<code>__len__()</code>ï¼Œè¯¥æ–¹æ³•è¿”å›æ•°æ®é›†çš„å°ºå¯¸ï¼Œè¯¥å°ºå¯¸ä¸Samplerçš„å®ç°å’ŒDataLoaderçš„é»˜è®¤é€‰é¡¹æœ‰å…³ã€‚</p>
<p>PSï¼šDataLoaderé»˜è®¤æ„å»ºä¸€ä¸ªç”Ÿæˆintegral indicesçš„index samplerã€‚ä¸ºäº†ä½¿å®ƒå¯ä»¥ä½œç”¨äºå…·æœ‰non-integral indices/keysçš„map-styleæ•°æ®é›†ï¼Œå¿…é¡»æä¾›ä¸€ä¸ªcustom samplerã€‚</p>
<h4 id="torchutilsdatadefault_collatebatch"><a class="markdownIt-Anchor" href="#torchutilsdatadefault_collatebatch"></a> torch.utils.data.default_collate(batch)</h4>
<p>ä¸€ä¸ªå‡½æ•°ï¼Œå°†a batch of dataä½œä¸ºè¾“å…¥ï¼Œå°†batchå†…çš„å…ƒç´ æ”¾å…¥ä¸€ä¸ªå…·æœ‰outer dimenstion (batch size)çš„tensorã€‚å…¶è¾“å‡ºç±»å‹å¯èƒ½æ˜¯ä¸€ä¸ª<code>torch.Tensor</code>ï¼Œä¸€ä¸ª<code>torch.Tensor</code>çš„Sequenceï¼Œä¸€ä¸ª<code>torch.Tensor</code>çš„Collectionï¼Œæˆ–è€…ä¸å˜ï¼Œå…¶ä¾èµ–äºè¾“å…¥ç±»å‹ã€‚å½“åœ¨DataLoaderä¸­å®šä¹‰batch_sizeæˆ–è€…batch_sampleræ—¶è¯¥å‡½æ•°å¯ä»¥ä½œä¸ºcollationçš„é»˜è®¤å‡½æ•°ã€‚ä¸‹é¢æ˜¯é€šå¸¸çš„input type (åŸºäºbatchå†…éƒ¨çš„å…ƒç´ ç±»å‹) å’Œå®ƒæ˜ å°„ä¸ºçš„output typeï¼š</p>
<p>å‚æ•°ï¼š</p>
<ul>
<li><code>batch</code>ï¼šç­‰å¾…æ•´ç†çš„single batch</li>
</ul>
<p>è°ƒç”¨å®ä¾‹ï¼š</p>
<pre><code># Example with a batch of `int`s:
default_collate([0, 1, 2, 3])
# Example with a batch of `str`s:
default_collate(['a', 'b', 'c'])
# Example with `Map` inside the batch:
default_collate([&#123;'A': 0, 'B': 1&#125;, &#123;'A': 100, 'B': 100&#125;])
# Example with `NamedTuple` inside the batch:
Point = namedtuple('Point', ['x', 'y'])
default_collate([Point(0, 0), Point(1, 1)])
# Example with `Tuple` inside the batch:
default_collate([(0, 1), (2, 3)])
# Example with `List` inside the batch:
default_collate([[0, 1], [2, 3]])
</code></pre>
<h4 id="torchutilsdatasamplerdata_source"><a class="markdownIt-Anchor" href="#torchutilsdatasamplerdata_source"></a> torch.utils.data.Sampler(data_source)</h4>
<p>æ‰€æœ‰Samplersçš„åŸºç±»ã€‚</p>
<p>æ¯ä¸ªSamplerå­ç±»å¿…é¡»æä¾›<code>__iter__()</code>æ–¹æ³•ï¼Œä»¥æ­¤æä¾›åœ¨datasetå…ƒç´ çš„indicesä¸Šçš„è¿­ä»£ï¼Œå’Œä¸€ä¸ª<code>__len__()</code>è¿”å›è¿­ä»£å™¨çš„é•¿åº¦ã€‚</p>
<p>PSï¼š<code>__len__()</code>å¹¶ä¸æ˜¯DataLoaderä¸¥æ ¼è¦æ±‚çš„ï¼Œä½†æ˜¯åœ¨æœ‰ä»»ä½•æ¶‰åŠåˆ°DataLoaderçš„é•¿åº¦è®¡ç®—æ—¶æœ€å¥½æä¾›ã€‚</p>
<blockquote>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/data.html">TORCH.UTILS.DATA</a></li>
</ol>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>å¹»å…‰
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://tom89757.github.io/2022/07/20/PyTorch-torch-utils-data/" title="PyTorch torch.utils.data">https://tom89757.github.io/2022/07/20/PyTorch-torch-utils-data/</a>
  </li>
  <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Pytorch/" rel="tag"># Pytorch</a>
              <a href="/tags/%E6%96%87%E6%A1%A3/" rel="tag"># æ–‡æ¡£</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/07/20/PyTorch-saving-and-loading-models/" rel="prev" title="PyTorch saving and loading models">
                  <i class="fa fa-chevron-left"></i> PyTorch saving and loading models
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/07/20/PyTorch-%E4%BC%98%E5%8C%96%E5%99%A8/" rel="next" title="PyTorch ä¼˜åŒ–å™¨">
                  PyTorch ä¼˜åŒ–å™¨ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¹»å…‰</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">348k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">5:16</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">


<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '480px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: false,
  label: 'ğŸŒ“',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
